<script>
    let data = [];
    let stationList = []; // 모든 역명을 저장할 배열

    // CSV 파일 로드 및 병합
    const loadCSV = async (url) => {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                header: true,
                complete: function(results) {
                    resolve(results.data);
                },
                error: function(error) {
                    reject(error);
                }
            });
        });
    };

    // 데이터 파일 경로
    const file1 = "데이터파일/우대권병합데이터06.csv";
    const file2 = "데이터파일/우대권병합데이터12.csv";

    // 파일 로드 및 병합
    Promise.all([loadCSV(file1), loadCSV(file2)]).then(results => {
        data = results[0].concat(results[1]); // 두 파일 병합
        console.log("Loaded data (first 5 rows):", data.slice(0, 5)); // 로드된 데이터의 첫 5행 출력

        // 모든 역명을 추출하여 배열에 저장
        stationList = [...new Set(data.map(row => row['역명'] ? row['역명'].trim() : ""))].filter(Boolean);
        console.log("Station list:", stationList); // 확인용 출력
        alert("CSV Files Loaded!");
    }).catch(error => {
        console.error("Error loading files:", error);
    });

    // 검색 버튼 클릭 이벤트
    document.getElementById('search').addEventListener('click', function() {
        const inputDate = document.getElementById('date').value; // 사용자가 입력한 날짜
        const inputHour = document.getElementById('hour').value; // 사용자가 입력한 시간
        const stationName = document.getElementById('station').value.trim(); // 사용자가 입력한 역명 (공백 제거)

        if (!inputDate || !inputHour || !stationName) {
            document.getElementById('results').textContent = "Please enter date, hour, and station name.";
            return;
        }

        // "잠시만 기다려주세요" 메시지 표시
        document.getElementById('results').textContent = "잠시만 기다려주세요...";

        // 검색 로직 실행
        setTimeout(() => {
            // 역명 리스트 확인 및 비교
            console.log("Station list:", stationList); // 로드된 역명 리스트 출력
            if (!stationList.some(station => station.toLowerCase() === stationName.toLowerCase())) {
                alert("올바른 역명을 입력하세요.");
                document.getElementById('results').textContent = ""; // 메시지 초기화
                return;
            }

            console.log(`Searching for date: ${inputDate}, hour: ${inputHour}, station: ${stationName}`); // 검색 조건 확인

            // 필터링: 날짜, 시간, 역명을 기준으로 데이터 검색
            const filteredData = data.filter(row => {
                const rowDate = row['일시'] ? new Date(row['일시']).toLocaleDateString('en-CA').slice(5) : ""; // mm-dd 형식
                const rowHour = row['일시'] ? new Date(row['일시']).getHours() : null; // 시간
                const rowStation = row['역명'] ? row['역명'].trim() : ""; // 역명이 존재하면 공백 제거

                console.log(`Row date: ${rowDate}, Row hour: ${rowHour}, Station: ${rowStation}`); // 각 행의 날짜, 시간, 역명 확인
                return rowDate === inputDate && rowHour == inputHour && rowStation.toLowerCase() === stationName.toLowerCase();
            });

            console.log("Filtered data:", filteredData); // 필터링된 데이터 확인

            // 총 인원수 계산
            const totalPassengers = filteredData.reduce((sum, row) => sum + parseInt(row['인원수'] || 0), 0);

            // 노약자 좌석 수 결정
            const elderlySeatCount = totalPassengers >= 170 ? 27 : 12;

            // 결과 표시
            if (filteredData.length > 0) {
                document.getElementById('results').innerHTML = `
                    <p><strong>Station:</strong> ${stationName}</p>
                    <p><strong>Date:</strong> ${inputDate}</p>
                    <p><strong>Hour:</strong> ${inputHour}:00</p>
                    <p><strong>Total Passengers:</strong> ${totalPassengers}</p>
                    <p><strong>Elderly Seats:</strong> ${elderlySeatCount} seats</p>
                `;
            } else {
                document.getElementById('results').innerHTML = `
                    <p>No data found for station: ${stationName}</p>
                    <p>on date: ${inputDate} at hour: ${inputHour}:00</p>
                `;
            }
        }, 1000); // 1초 딜레이 추가
    });
</script>
