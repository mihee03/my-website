// 지도 초기화
var map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.3595316, 127.1052133), // 서울 중심 좌표
    zoom: 15,
    mapTypeControl: true
});

var infoWindow = new naver.maps.InfoWindow({
    anchorSkew: true
});

map.setCursor('pointer');

// 좌표에서 주소를 검색하는 함수
function searchCoordinateToAddress(latlng) {
    infoWindow.close();

    naver.maps.Service.reverseGeocode({
        coords: latlng,
        orders: [
            naver.maps.Service.OrderType.ADDR,
            naver.maps.Service.OrderType.ROAD_ADDR
        ].join(',')
    }, function(status, response) {
        if (status === naver.maps.Service.Status.ERROR) {
            return alert('Something Wrong!');
        }

        var items = response.v2.results,
            address = '',
            htmlAddresses = [];

        for (var i = 0, ii = items.length, item, addrType; i < ii; i++) {
            item = items[i];
            address = makeAddress(item) || '';
            addrType = item.name === 'roadaddr' ? '[도로명 주소]' : '[지번 주소]';

            htmlAddresses.push((i + 1) + '. ' + addrType + ' ' + address);
        }

        infoWindow.setContent([
            '<div style="padding:10px;min-width:200px;line-height:150%;">',
            '<h4 style="margin-top:5px;">검색 좌표</h4><br />',
            htmlAddresses.join('<br />'),
            '</div>'
        ].join('\n'));

        infoWindow.open(map, latlng);
    });
}

// 주소에서 좌표를 검색하는 함수
function searchAddressToCoordinate(address) {
    naver.maps.Service.geocode({
        query: address
    }, function(status, response) {
        if (status === naver.maps.Service.Status.ERROR) {
            return alert('Something Wrong!');
        }

        if (response.v2.meta.totalCount === 0) {
            return alert('검색 결과가 없습니다.');
        }

        var htmlAddresses = [],
            item = response.v2.addresses[0],
            point = new naver.maps.Point(item.x, item.y);

        if (item.roadAddress) {
            htmlAddresses.push('[도로명 주소] ' + item.roadAddress);
        }

        if (item.jibunAddress) {
            htmlAddresses.push('[지번 주소] ' + item.jibunAddress);
        }

        if (item.englishAddress) {
            htmlAddresses.push('[영문명 주소] ' + item.englishAddress);
        }

        infoWindow.setContent([
            '<div style="padding:10px;min-width:200px;line-height:150%;">',
            '<h4 style="margin-top:5px;">검색 주소 : ' + address + '</h4><br />',
            htmlAddresses.join('<br />'),
            '</div>'
        ].join('\n'));

        map.setCenter(point);
        infoWindow.open(map, point);
    });
}

// 검색 결과를 지도와 페이지에 표시
function displayResults(places) {
    // 이전 결과 초기화
    document.getElementById("results").innerHTML = "";
    map.setCenter(new naver.maps.LatLng(37.5665, 126.9780)); // 지도 중심 초기화

    places.forEach(place => {
        // 지도에 마커 추가
        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(place.mapy, place.mapx),
            map: map,
            title: place.title.replace(/<[^>]+>/g, "") // HTML 태그 제거
        });

        // 마커 클릭 이벤트 (정보창 표시)
        const infoWindow = new naver.maps.InfoWindow({
            content: `<div><strong>${place.title}</strong><br>${place.address}</div>`
        });

        naver.maps.Event.addListener(marker, "click", () => {
            infoWindow.open(map, marker);
        });

        // 검색 결과 목록 추가
        document.getElementById("results").innerHTML += `
            <div class="result-item">
                <strong>${place.title.replace(/<[^>]+>/g, "")}</strong><br>
                ${place.address}<br>
                <a href="${place.link}" target="_blank">상세보기</a>
            </div>
        `;
    });
}

// 검색 버튼 클릭 이벤트
document.getElementById("search-button").addEventListener("click", () => {
    const query = document.getElementById("search-input").value;
    if (query.trim()) {
        searchPlaces(query.trim()); // 검색 실행
    } else {
        alert("검색어를 입력하세요!");
    }
});
